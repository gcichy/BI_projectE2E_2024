from zipfile import ZipFile, ZIP_DEFLATED
from lxml import etree

INPUT_DOTM = "template.dotm"
OUTPUT_DOTM = "template_modified.dotm"

# Namespace for WordprocessingML
NS = {"w": "http://schemas.openxmlformats.org/wordprocessingml/2006/main"}

# 1. Read document.xml from the .dotm
with ZipFile(INPUT_DOTM, "r") as zin:
    # Get the raw XML bytes of word/document.xml
    document_xml_bytes = zin.read("word/document.xml")

    # Parse XML
    root = etree.fromstring(document_xml_bytes)
    
    # === Example modification ===
    # Change the text of the first run in the first paragraph
    # Adjust the XPath as needed for your real scenario
    first_text_nodes = root.xpath("//w:p[1]//w:t[1]", namespaces=NS)
    if first_text_nodes:
        first_text_nodes[0].text = "Hello from Python inside DOTM!"
    
    # Serialize modified XML back to bytes
    new_document_xml_bytes = etree.tostring(
        root,
        xml_declaration=True,
        encoding="UTF-8",
        standalone="yes"
    )

    # 2. Write a new .dotm with modified document.xml
    with ZipFile(OUTPUT_DOTM, "w", ZIP_DEFLATED) as zout:
        for item in zin.infolist():
            if item.filename == "word/document.xml":
                # Write our modified document.xml
                zout.writestr(item, new_document_xml_bytes)
            else:
                # Copy everything else unchanged
                zout.writestr(item, zin.read(item.filename))
