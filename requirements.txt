from lxml import etree

W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main"
XML_NS = "http://www.w3.org/XML/1998/namespace"

def qn(local: str) -> str:
    return f"{{{W_NS}}}{local}"

def set_run_text_with_newlines(r: etree._Element, text: str) -> None:
    """
    Replace the contents of a <w:r> with text where '\n' becomes <w:br/>.
    Keeps existing run properties (<w:rPr>) if present.
    """
    # keep run properties if present
    rpr = r.find(qn("rPr"))

    # remove everything except rPr
    for child in list(r):
        if child is not rpr:
            r.remove(child)

    parts = text.split("\n")

    for i, part in enumerate(parts):
        if i > 0:
            etree.SubElement(r, qn("br"))

        t = etree.SubElement(r, qn("t"))
        # Preserve leading/trailing spaces (Word collapses otherwise)
        if part.startswith(" ") or part.endswith(" "):
            t.set(f"{{{XML_NS}}}space", "preserve")
        t.text = part
