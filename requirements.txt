from io import BytesIO
from zipfile import ZipFile, ZIP_DEFLATED
from lxml import etree
from docx import Document  # python-docx

W_NS = "http://schemas.openxmlformats.org/wordprocessingml/2006/main"
NS = {"w": W_NS}


def modify_document_xml(xml_bytes: bytes) -> bytes:
    """
    Receives word/document.xml as bytes, returns modified bytes.
    Example modification: append " !!!" to every <w:t>.
    """
    root = etree.fromstring(xml_bytes)  # bytes => OK even with XML declaration

    for t in root.xpath("//w:t", namespaces=NS):
        if t.text:
            t.text = t.text + " !!!"

    # Keep standalone / declaration like Word expects
    return etree.tostring(root, xml_declaration=True, encoding="UTF-8", standalone="yes")


def doc_to_modified_docx_bytes(doc: Document) -> bytes:
    # 1) Save Document to BytesIO
    src_buf = BytesIO()
    doc.save(src_buf)
    src_buf.seek(0)

    # 2) Read as zip, modify document.xml, rebuild zip in memory
    out_buf = BytesIO()

    with ZipFile(src_buf, "r") as zin, ZipFile(out_buf, "w", compression=ZIP_DEFLATED) as zout:
        # Read original document.xml
        original_xml = zin.read("word/document.xml")
        new_xml = modify_document_xml(original_xml)

        for item in zin.infolist():
            data = zin.read(item.filename)

            # Replace only document.xml
            if item.filename == "word/document.xml":
                data = new_xml

            # Write everything back (keeps all relationships/parts intact)
            zout.writestr(item, data)

    return out_buf.getvalue()


def rebuild_document_from_bytes(docx_bytes: bytes) -> Document:
    buf = BytesIO(docx_bytes)
    return Document(buf)


# -------------------
# Demo usage
# -------------------
doc = Document()
doc.add_paragraph("Hello world")

modified_bytes = doc_to_modified_docx_bytes(doc)
new_doc = rebuild_document_from_bytes(modified_bytes)

print(new_doc.paragraphs[0].text)  # "Hello world !!!"
